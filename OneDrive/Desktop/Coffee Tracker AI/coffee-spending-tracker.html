<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Spending Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FFF8E7 0%, #FAEBD7 100%);
            color: #3E2723;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #6F4E37 0%, #3E2723 100%);
            color: #FFF8E7;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(62, 39, 35, 0.3);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(111, 78, 55, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(111, 78, 55, 0.15);
        }

        .section-title {
            font-size: 1.8em;
            color: #6F4E37;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #F5E6D3;
        }

        .upload-zone {
            border: 3px dashed #A0826D;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #FFF8E7;
        }

        .upload-zone:hover {
            border-color: #6F4E37;
            background: #F5E6D3;
            transform: scale(1.02);
        }

        .upload-zone.dragover {
            border-color: #3E2723;
            background: #F5E6D3;
            transform: scale(1.05);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #6F4E37;
            margin-bottom: 10px;
        }

        .file-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #F5E6D3;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .file-item:hover {
            background: #A0826D;
            color: white;
        }

        .file-name {
            font-weight: 600;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-pending {
            background: #FFA726;
        }

        .status-processing {
            background: #42A5F5;
            animation: pulse 1.5s infinite;
        }

        .status-complete {
            background: #66BB6A;
        }

        .status-error {
            background: #EF5350;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6F4E37 0%, #3E2723 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(62, 39, 35, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(62, 39, 35, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #A0826D;
            color: white;
        }

        .btn-secondary:hover {
            background: #6F4E37;
            transform: translateY(-2px);
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .api-key-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #A0826D;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 20px;
            background: #FFF8E7;
            color: #3E2723;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #6F4E37;
            box-shadow: 0 0 10px rgba(111, 78, 55, 0.2);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner.active {
            display: block;
        }

        .spinner {
            border: 4px solid #F5E6D3;
            border-top: 4px solid #6F4E37;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #6F4E37 0%, #A0826D 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(111, 78, 55, 0.3);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: 700;
            margin: 10px 0;
        }

        .metric-label {
            font-size: 1em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .transaction-list {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #F5E6D3;
            border-radius: 10px;
            padding: 20px;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #F5E6D3;
            transition: background 0.3s ease;
        }

        .transaction-item:hover {
            background: #FFF8E7;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-checkbox {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .transaction-details {
            flex: 1;
            display: grid;
            grid-template-columns: 150px 1fr 120px;
            gap: 15px;
            align-items: center;
        }

        .transaction-date {
            color: #6F4E37;
            font-weight: 600;
        }

        .transaction-merchant {
            color: #3E2723;
        }

        .transaction-amount {
            text-align: right;
            font-weight: 700;
            font-size: 1.1em;
            color: #6F4E37;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }

        .insight-card {
            background: #F5E6D3;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #6F4E37;
        }

        .insight-title {
            font-weight: 700;
            color: #6F4E37;
            margin-bottom: 5px;
        }

        .insight-value {
            font-size: 1.3em;
            color: #3E2723;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #FFEBEE;
            color: #C62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #C62828;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            h1 {
                font-size: 1.6em;
            }

            .subtitle {
                font-size: 0.95em;
            }

            .section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .section-title {
                font-size: 1.4em;
            }

            .upload-zone {
                padding: 40px 15px;
            }

            .upload-icon {
                font-size: 3em;
            }

            .upload-text {
                font-size: 1em;
            }

            .transaction-details {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .transaction-date {
                font-size: 0.9em;
            }

            .transaction-merchant {
                font-size: 0.95em;
            }

            .transaction-amount {
                text-align: left;
                font-size: 1em;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .metric-card {
                padding: 20px;
            }

            .metric-value {
                font-size: 2em;
            }

            .btn {
                padding: 12px 30px;
                font-size: 1em;
            }

            .button-group {
                flex-direction: column;
                gap: 15px;
            }

            .button-group .btn {
                width: 100%;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .file-status {
                width: 100%;
                justify-content: space-between;
            }

            .insight-card {
                padding: 15px;
            }

            .insight-value {
                font-size: 1.1em;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.4em;
            }

            .section {
                padding: 15px 10px;
            }

            .metric-value {
                font-size: 1.8em;
            }

            .upload-zone {
                padding: 30px 10px;
            }
        }

        .select-all-container {
            margin-bottom: 15px;
            padding: 10px;
            background: #F5E6D3;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .help-text {
            font-size: 0.9em;
            color: #6F4E37;
            margin-top: 10px;
            font-style: italic;
        }

        .footer {
            background: linear-gradient(135deg, #6F4E37 0%, #3E2723 100%);
            color: #FFF8E7;
            border-radius: 20px;
            padding: 30px;
            margin-top: 40px;
            text-align: center;
        }

        .footer-copyright {
            font-size: 1em;
            margin-bottom: 20px;
        }

        .footer-disclaimer {
            border-top: 1px solid rgba(255, 248, 231, 0.3);
            padding-top: 20px;
            font-size: 0.75em;
            color: rgba(255, 248, 231, 0.8);
            line-height: 1.8;
        }

        .footer-disclaimer-title {
            font-weight: 600;
            color: #FFF8E7;
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .footer-disclaimer p {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>â˜• Coffee Spending Tracker</h1>
            <p class="subtitle">Discover your coffee habits and potential savings</p>
        </header>

        <div class="section">
            <h2 class="section-title">ðŸ“¤ Upload Your Statements</h2>

            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">ðŸ“„</div>
                <div class="upload-text">Drag & drop up to 12 PDF statements here</div>
                <div class="upload-text" style="font-size: 0.9em; color: #A0826D;">or click to browse (1-12 months)</div>
                <input type="file" id="fileInput" accept=".pdf" multiple style="display: none;">
            </div>

            <div class="file-list" id="fileList"></div>

            <div class="button-group">
                <button class="btn btn-primary" id="analyzeBtn" disabled>Analyze Spending</button>
                <button class="btn btn-secondary" id="resetBtn">Reset</button>
            </div>

            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p id="loadingText">Analyzing your coffee spending with Claude AI...</p>
            </div>
        </div>

        <div id="errorContainer"></div>

        <div id="resultsSection" class="hidden">
            <div class="section">
                <h2 class="section-title">ðŸ“‹ Coffee Transactions</h2>
                <div class="select-all-container">
                    <input type="checkbox" id="selectAll" class="transaction-checkbox" checked>
                    <label for="selectAll" style="font-weight: 600; cursor: pointer;">Select/Deselect All Transactions</label>
                </div>
                <div class="transaction-list" id="transactionList"></div>
            </div>

            <div class="section">
                <h2 class="section-title">ðŸ“Š Key Metrics</h2>
                <div class="metrics-grid" id="metricsGrid"></div>
            </div>

            <div class="section">
                <h2 class="section-title">ðŸ“ˆ Visualizations</h2>
                <div class="charts-grid">
                    <div>
                        <h3 style="text-align: center; color: #6F4E37; margin-bottom: 20px;">Coffee Shops by Total Spending</h3>
                        <div class="chart-container">
                            <canvas id="shopRankingChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 style="text-align: center; color: #6F4E37; margin-bottom: 20px;">Spending Distribution</h3>
                        <div class="chart-container">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="charts-grid">
                    <div>
                        <h3 style="text-align: center; color: #6F4E37; margin-bottom: 20px;">Weekly Spending Trend</h3>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 style="text-align: center; color: #6F4E37; margin-bottom: 20px;">Spending by Day of Week</h3>
                        <div class="chart-container">
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">ðŸ’¡ Insights & Savings</h2>
                <div id="insightsContainer"></div>
            </div>

            <div class="section">
                <h2 class="section-title">ðŸ’¾ Export Data</h2>
                <div class="button-group">
                    <button class="btn btn-primary" id="exportCsvBtn">Export to CSV</button>
                    <button class="btn btn-primary" id="exportPdfBtn">Export to PDF</button>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p class="footer-copyright">Coffee Spending Tracker Â© 2026 - Powered by Claude AI</p>
            <div class="footer-disclaimer">
                <p class="footer-disclaimer-title">Disclaimer</p>
                <p>
                    This tool is provided for informational and educational purposes only. We make no warranties
                    or representations regarding the accuracy, completeness, or reliability of the analysis results.
                    The identification of coffee-related transactions is automated and may contain errors or omissions.
                </p>
                <p>
                    We are not liable for any decisions made based on the information provided by this tool.
                    Always verify transaction data against your official bank statements. This service does not
                    constitute financial advice. Your uploaded files are processed in-memory and are not stored on our servers.
                </p>
                <p>
                    By using this service, you acknowledge that you have read and agree to these terms.
                </p>
            </div>
        </footer>
    </div>

    <script>
        const COFFEE_KEYWORDS = [
            'starbucks', 'tim hortons', 'dunkin', 'peet', 'costa coffee',
            'coffee', 'cafe', 'espresso', 'latte', 'cappuccino', 'mocha',
            'americano', 'macchiato', 'frappuccino', 'cold brew'
        ];

        let uploadedFiles = [];
        let transactions = [];
        let charts = {};

        const elements = {
            uploadZone: document.getElementById('uploadZone'),
            fileInput: document.getElementById('fileInput'),
            fileList: document.getElementById('fileList'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            resetBtn: document.getElementById('resetBtn'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            resultsSection: document.getElementById('resultsSection'),
            transactionList: document.getElementById('transactionList'),
            metricsGrid: document.getElementById('metricsGrid'),
            insightsContainer: document.getElementById('insightsContainer'),
            errorContainer: document.getElementById('errorContainer'),
            selectAll: document.getElementById('selectAll'),
            exportCsvBtn: document.getElementById('exportCsvBtn'),
            exportPdfBtn: document.getElementById('exportPdfBtn')
        };

        // Upload zone interactions
        elements.uploadZone.addEventListener('click', () => elements.fileInput.click());

        elements.uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.uploadZone.classList.add('dragover');
        });

        elements.uploadZone.addEventListener('dragleave', () => {
            elements.uploadZone.classList.remove('dragover');
        });

        elements.uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        elements.fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        elements.analyzeBtn.addEventListener('click', analyzeFiles);
        elements.resetBtn.addEventListener('click', resetApp);
        elements.selectAll.addEventListener('change', toggleAllTransactions);
        elements.exportCsvBtn.addEventListener('click', exportToCSV);
        elements.exportPdfBtn.addEventListener('click', exportToPDF);

        function handleFiles(files) {
            const pdfFiles = Array.from(files).filter(f => f.type === 'application/pdf');

            if (uploadedFiles.length + pdfFiles.length > 12) {
                showError('Maximum 12 PDF files allowed (one per month)');
                return;
            }

            uploadedFiles = [...uploadedFiles, ...pdfFiles].slice(0, 12);
            updateFileList();
            updateAnalyzeButton();
        }

        function updateFileList() {
            elements.fileList.innerHTML = uploadedFiles.map((file, index) => `
                <div class="file-item">
                    <span class="file-name">ðŸ“„ ${file.name}</span>
                    <div class="file-status">
                        <span class="status-indicator status-pending" id="status-${index}"></span>
                        <span id="status-text-${index}">Ready</span>
                        <button onclick="removeFile(${index})" style="margin-left: 10px; padding: 5px 10px; background: #EF5350; color: white; border: none; border-radius: 5px; cursor: pointer;">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            const hasFiles = uploadedFiles.length > 0;
            elements.analyzeBtn.disabled = !hasFiles;
        }

        async function analyzeFiles() {
            if (uploadedFiles.length === 0) {
                showError('Please upload at least one PDF file');
                return;
            }

            elements.loadingSpinner.classList.add('active');
            elements.analyzeBtn.disabled = true;
            clearError();
            transactions = [];

            const totalFiles = uploadedFiles.length;
            const loadingTextEl = document.getElementById('loadingText');

            for (let i = 0; i < uploadedFiles.length; i++) {
                const statusIndicator = document.getElementById(`status-${i}`);
                const statusText = document.getElementById(`status-text-${i}`);

                loadingTextEl.textContent = `Analyzing statement ${i + 1} of ${totalFiles} with Claude AI...`;

                statusIndicator.className = 'status-indicator status-processing';
                statusText.textContent = 'Processing...';

                try {
                    const fileTransactions = await analyzePdfWithClaude(uploadedFiles[i]);
                    transactions.push(...fileTransactions);

                    statusIndicator.className = 'status-indicator status-complete';
                    statusText.textContent = `Found ${fileTransactions.length} transactions`;
                } catch (error) {
                    console.error('Full error object:', error);
                    statusIndicator.className = 'status-indicator status-error';
                    statusText.textContent = `Error: ${error.message}`;
                    showError(`Error processing ${uploadedFiles[i].name}: ${error.message}`);
                }
            }

            elements.loadingSpinner.classList.remove('active');

            if (transactions.length > 0) {
                displayResults();
            } else {
                showError('No coffee transactions found in the uploaded statements');
                elements.analyzeBtn.disabled = false;
            }
        }

        async function analyzePdfWithClaude(file) {
            console.log('Analyzing file:', file.name);
            const base64 = await fileToBase64(file);
            console.log('Base64 length:', base64.length);

            const requestBody = {
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4096,
                messages: [{
                    role: 'user',
                    content: [
                        {
                            type: 'document',
                            source: {
                                type: 'base64',
                                media_type: 'application/pdf',
                                data: base64
                            }
                        },
                        {
                            type: 'text',
                            text: `Analyze this bank or credit card statement and identify ALL coffee-related transactions. Be THOROUGH and look carefully through every transaction.

IMPORTANT: Look for these patterns in merchant names:
1. Major coffee chains: Starbucks, Tim Hortons, Dunkin', Dunkin Donuts, Peet's Coffee, Costa Coffee, Blue Bottle, Caribou Coffee, Dutch Bros, Philz Coffee, etc.

2. Common coffee keywords (case-insensitive):
   - "Coffee" (e.g., "Main Street Coffee", "Johnson Coffee Co")
   - "Cafe" or "CafÃ©" (e.g., "Corner Cafe", "Sunrise CafÃ©")
   - "Roast" or "Roasters" (e.g., "Local Roast", "City Roasters")
   - "Espresso" (e.g., "Express Espresso", "Espresso Bar")
   - "Brew" or "Brewing" (e.g., "Fresh Brew", "Craft Brewing Co")
   - "Latte", "Cappuccino", "Mocha", "Americano", "Macchiato"
   - "Java" (e.g., "Java House", "Java Joe's")
   - "Bean" or "Beans" (e.g., "Magic Beans", "Coffee Bean")
   - "Grind" or "Grounds" (e.g., "Daily Grind", "Common Grounds")
   - "Barista" (e.g., "Barista Bar", "The Barista")

3. Coffee shop indicators:
   - Names containing "Coffee Shop", "Coffee House", "Coffeehouse"
   - Merchants with "Bakery & Coffee" or similar combinations
   - Independent local coffee shops (any unique name with coffee/cafe keywords)

CRITICAL: Include ALL transactions that match any of these patterns. Do not exclude transactions just because they seem small or large - coffee purchases can range from $2 to $15+.

For EACH coffee transaction found, extract:
1. Merchant/shop name (exactly as it appears)
2. Transaction date (format as YYYY-MM-DD)
3. Amount (positive number only, no currency symbols)

Return ONLY a valid JSON array with this exact structure:
[
  {
    "merchant": "Starbucks",
    "date": "2024-01-15",
    "amount": 6.50
  },
  {
    "merchant": "Main Street Cafe",
    "date": "2024-01-18",
    "amount": 4.75
  }
]

If no coffee transactions are found, return an empty array: []

Do not include any text before or after the JSON array. Be comprehensive - it's better to include a transaction that might be coffee-related than to miss one.`
                        }
                    ]
                }]
            };

            console.log('Sending request to backend API...');

            let response;
            try {
                // Send to backend API (works locally and when deployed)
                response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
            } catch (fetchError) {
                console.error('Fetch error:', fetchError);
                throw new Error('Network error - Unable to connect to server');
            }

            if (!response.ok) {
                let errorMessage = `API request failed (${response.status})`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error?.message || errorMessage;
                    console.error('API Error Details:', errorData);
                } catch (e) {
                    console.error('Failed to parse error response');
                }
                throw new Error(errorMessage);
            }

            const data = await response.json();
            const textContent = data.content.find(c => c.type === 'text')?.text || '[]';

            // Extract JSON from response
            const jsonMatch = textContent.match(/\[[\s\S]*\]/);
            const jsonStr = jsonMatch ? jsonMatch[0] : '[]';

            return JSON.parse(jsonStr);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function displayResults() {
            elements.resultsSection.classList.remove('hidden');

            displayTransactions();
            displayMetrics();
            displayCharts();
            displayInsights();

            elements.resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayTransactions() {
            const sortedTransactions = [...transactions].sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );

            elements.transactionList.innerHTML = sortedTransactions.map((t, index) => `
                <div class="transaction-item">
                    <input type="checkbox"
                           class="transaction-checkbox"
                           id="transaction-${index}"
                           checked
                           onchange="recalculateMetrics()">
                    <div class="transaction-details">
                        <div class="transaction-date">${formatDate(t.date)}</div>
                        <div class="transaction-merchant">${t.merchant}</div>
                        <div class="transaction-amount">$${t.amount.toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleAllTransactions() {
            const checkboxes = document.querySelectorAll('.transaction-item input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = elements.selectAll.checked);
            recalculateMetrics();
        }

        function getSelectedTransactions() {
            return transactions.filter((_, index) => {
                const checkbox = document.getElementById(`transaction-${index}`);
                return checkbox && checkbox.checked;
            });
        }

        function recalculateMetrics() {
            displayMetrics();
            displayCharts();
            displayInsights();
        }

        function displayMetrics() {
            const selected = getSelectedTransactions();
            const total = selected.reduce((sum, t) => sum + t.amount, 0);
            const count = selected.length;

            const dates = selected.map(t => new Date(t.date));
            const daysDiff = (Math.max(...dates) - Math.min(...dates)) / (1000 * 60 * 60 * 24) || 1;
            const weeksDiff = daysDiff / 7 || 1;
            const monthsDiff = daysDiff / 30 || 1;

            const metrics = [
                { label: 'Total Spending', value: `$${total.toFixed(2)}` },
                { label: 'Total Purchases', value: count },
                { label: 'Average per Day', value: `$${(total / daysDiff).toFixed(2)}` },
                { label: 'Average per Week', value: `$${(total / weeksDiff).toFixed(2)}` },
                { label: 'Average per Month', value: `$${(total / monthsDiff).toFixed(2)}` },
                { label: 'Average per Purchase', value: `$${(total / count).toFixed(2)}` }
            ];

            elements.metricsGrid.innerHTML = metrics.map(m => `
                <div class="metric-card">
                    <div class="metric-label">${m.label}</div>
                    <div class="metric-value">${m.value}</div>
                </div>
            `).join('');
        }

        function displayCharts() {
            const selected = getSelectedTransactions();

            // Destroy existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // Shop ranking
            const shopData = {};
            selected.forEach(t => {
                shopData[t.merchant] = (shopData[t.merchant] || 0) + t.amount;
            });
            const sortedShops = Object.entries(shopData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            charts.shopRanking = new Chart(document.getElementById('shopRankingChart'), {
                type: 'bar',
                data: {
                    labels: sortedShops.map(s => s[0]),
                    datasets: [{
                        label: 'Total Spending ($)',
                        data: sortedShops.map(s => s[1]),
                        backgroundColor: '#6F4E37',
                        borderColor: '#3E2723',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Pie chart
            charts.pie = new Chart(document.getElementById('pieChart'), {
                type: 'pie',
                data: {
                    labels: sortedShops.map(s => s[0]),
                    datasets: [{
                        data: sortedShops.map(s => s[1]),
                        backgroundColor: [
                            '#6F4E37', '#A0826D', '#3E2723', '#8D6E63',
                            '#5D4037', '#4E342E', '#795548', '#6D4C41',
                            '#A1887F', '#BCAAA4'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Weekly trend
            const weeklyData = {};
            selected.forEach(t => {
                const date = new Date(t.date);
                // Get the week start date (Sunday)
                const dayOfWeek = date.getDay();
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - dayOfWeek);
                const weekKey = weekStart.toISOString().substring(0, 10);
                weeklyData[weekKey] = (weeklyData[weekKey] || 0) + t.amount;
            });
            const sortedWeeks = Object.entries(weeklyData).sort();

            charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: sortedWeeks.map(w => {
                        const date = new Date(w[0]);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Weekly Spending ($)',
                        data: sortedWeeks.map(w => w[1]),
                        borderColor: '#6F4E37',
                        backgroundColor: 'rgba(111, 78, 55, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Day of week
            const dayData = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0 };
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            selected.forEach(t => {
                const day = dayNames[new Date(t.date).getDay()];
                dayData[day] += t.amount;
            });

            charts.dayOfWeek = new Chart(document.getElementById('dayOfWeekChart'), {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Spending by Day ($)',
                        data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(d => dayData[d]),
                        backgroundColor: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(() => '#6F4E37')
                            .concat(['Sat', 'Sun'].map(() => '#A0826D')),
                        borderWidth: 2,
                        borderColor: '#3E2723'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function displayInsights() {
            const selected = getSelectedTransactions();
            const total = selected.reduce((sum, t) => sum + t.amount, 0);
            const count = selected.length;
            const maxTransaction = Math.max(...selected.map(t => t.amount));
            const homeSavings = count * 0.50;
            const potentialSavings = total - homeSavings;

            const weekendSpending = selected
                .filter(t => {
                    const day = new Date(t.date).getDay();
                    return day === 0 || day === 6;
                })
                .reduce((sum, t) => sum + t.amount, 0);

            const weekdaySpending = total - weekendSpending;

            elements.insightsContainer.innerHTML = `
                <div class="insight-card">
                    <div class="insight-title">â˜• Most Expensive Single Purchase</div>
                    <div class="insight-value">$${maxTransaction.toFixed(2)}</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">ðŸ’° Potential Annual Savings (Home Coffee)</div>
                    <div class="insight-value">$${(potentialSavings * 4).toFixed(2)} per year</div>
                    <div style="margin-top: 10px; font-size: 0.9em;">Based on $0.50 per cup at home vs $${(total/count).toFixed(2)} average purchase</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">ðŸ“… Weekday vs Weekend Spending</div>
                    <div class="insight-value">Weekdays: $${weekdaySpending.toFixed(2)} | Weekends: $${weekendSpending.toFixed(2)}</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">ðŸ“Š Total Coffee Purchases</div>
                    <div class="insight-value">${count} purchases in ${Math.ceil(getDayRange(selected))} days</div>
                </div>
            `;
        }

        function getDayRange(transactions) {
            const dates = transactions.map(t => new Date(t.date));
            return (Math.max(...dates) - Math.min(...dates)) / (1000 * 60 * 60 * 24);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function exportToCSV() {
            const selected = getSelectedTransactions();
            const total = selected.reduce((sum, t) => sum + t.amount, 0);
            const count = selected.length;

            const dates = selected.map(t => new Date(t.date));
            const daysDiff = (Math.max(...dates) - Math.min(...dates)) / (1000 * 60 * 60 * 24) || 1;
            const weeksDiff = daysDiff / 7 || 1;
            const monthsDiff = daysDiff / 30 || 1;

            const maxTransaction = Math.max(...selected.map(t => t.amount));
            const homeSavings = count * 0.50;
            const potentialSavings = total - homeSavings;

            // Calculate shop rankings
            const shopData = {};
            selected.forEach(t => {
                shopData[t.merchant] = (shopData[t.merchant] || 0) + t.amount;
            });
            const sortedShops = Object.entries(shopData).sort((a, b) => b[1] - a[1]);

            // Calculate day of week spending
            const weekendSpending = selected.filter(t => {
                const day = new Date(t.date).getDay();
                return day === 0 || day === 6;
            }).reduce((sum, t) => sum + t.amount, 0);
            const weekdaySpending = total - weekendSpending;

            // Build comprehensive CSV
            let csv = 'COFFEE SPENDING ANALYSIS REPORT\n\n';

            csv += 'KEY METRICS\n';
            csv += 'Metric,Value\n';
            csv += `Total Spending,$${total.toFixed(2)}\n`;
            csv += `Total Purchases,${count}\n`;
            csv += `Average per Day,$${(total / daysDiff).toFixed(2)}\n`;
            csv += `Average per Week,$${(total / weeksDiff).toFixed(2)}\n`;
            csv += `Average per Month,$${(total / monthsDiff).toFixed(2)}\n`;
            csv += `Average per Purchase,$${(total / count).toFixed(2)}\n`;
            csv += `Most Expensive Purchase,$${maxTransaction.toFixed(2)}\n`;
            csv += `Potential Annual Savings (vs home coffee),$${(potentialSavings * 4).toFixed(2)}\n`;
            csv += `Weekday Spending,$${weekdaySpending.toFixed(2)}\n`;
            csv += `Weekend Spending,$${weekendSpending.toFixed(2)}\n`;
            csv += `Analysis Period,${Math.ceil(daysDiff)} days\n\n`;

            csv += 'SPENDING BY COFFEE SHOP\n';
            csv += 'Shop Name,Total Spent,Number of Visits\n';
            sortedShops.forEach(([shop, amount]) => {
                const visits = selected.filter(t => t.merchant === shop).length;
                csv += `"${shop}",$${amount.toFixed(2)},${visits}\n`;
            });
            csv += '\n';

            csv += 'ALL TRANSACTIONS\n';
            csv += 'Date,Merchant,Amount\n';
            selected.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                csv += `${t.date},"${t.merchant}",$${t.amount.toFixed(2)}\n`;
            });

            downloadFile(csv, 'coffee-spending-analysis.csv', 'text/csv');
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const selected = getSelectedTransactions();
            const total = selected.reduce((sum, t) => sum + t.amount, 0);
            const count = selected.length;

            const dates = selected.map(t => new Date(t.date));
            const daysDiff = (Math.max(...dates) - Math.min(...dates)) / (1000 * 60 * 60 * 24) || 1;
            const weeksDiff = daysDiff / 7 || 1;
            const monthsDiff = daysDiff / 30 || 1;

            const maxTransaction = Math.max(...selected.map(t => t.amount));
            const homeSavings = count * 0.50;
            const potentialSavings = total - homeSavings;

            const weekendSpending = selected.filter(t => {
                const day = new Date(t.date).getDay();
                return day === 0 || day === 6;
            }).reduce((sum, t) => sum + t.amount, 0);
            const weekdaySpending = total - weekendSpending;

            // Calculate shop rankings
            const shopData = {};
            selected.forEach(t => {
                shopData[t.merchant] = (shopData[t.merchant] || 0) + t.amount;
            });
            const sortedShops = Object.entries(shopData).sort((a, b) => b[1] - a[1]).slice(0, 10);

            // Page 1: Summary
            doc.setFillColor(111, 78, 55);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('Coffee Spending Analysis', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            doc.setTextColor(62, 39, 35);
            doc.setFontSize(16);
            doc.text('Key Metrics', 20, 55);

            doc.setFontSize(11);
            let y = 65;
            const metrics = [
                [`Total Spending: $${total.toFixed(2)}`, `Total Purchases: ${count}`],
                [`Avg per Day: $${(total / daysDiff).toFixed(2)}`, `Avg per Week: $${(total / weeksDiff).toFixed(2)}`],
                [`Avg per Month: $${(total / monthsDiff).toFixed(2)}`, `Avg per Purchase: $${(total / count).toFixed(2)}`],
                [`Most Expensive: $${maxTransaction.toFixed(2)}`, `Analysis Period: ${Math.ceil(daysDiff)} days`]
            ];

            metrics.forEach(([left, right]) => {
                doc.text(left, 20, y);
                doc.text(right, 110, y);
                y += 10;
            });

            // Insights
            doc.setFontSize(16);
            doc.text('Insights & Savings', 20, y + 10);
            y += 20;

            doc.setFontSize(11);
            doc.text(`Potential Annual Savings: $${(potentialSavings * 4).toFixed(2)}`, 20, y);
            y += 7;
            doc.setFontSize(9);
            doc.text(`(Based on $0.50 per cup at home vs $${(total/count).toFixed(2)} average purchase)`, 25, y);
            y += 10;

            doc.setFontSize(11);
            doc.text(`Weekday Spending: $${weekdaySpending.toFixed(2)} | Weekend: $${weekendSpending.toFixed(2)}`, 20, y);

            // Top Coffee Shops
            y += 15;
            doc.setFontSize(16);
            doc.text('Top Coffee Shops', 20, y);
            y += 10;

            doc.setFontSize(10);
            sortedShops.forEach(([shop, amount], idx) => {
                const visits = selected.filter(t => t.merchant === shop).length;
                doc.text(`${idx + 1}. ${shop}`, 20, y);
                doc.text(`$${amount.toFixed(2)} (${visits} visits)`, 150, y);
                y += 7;
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });

            // Page 2: Transactions
            doc.addPage();
            doc.setFillColor(111, 78, 55);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.text('All Transactions', 105, 18, { align: 'center' });

            doc.setTextColor(62, 39, 35);
            doc.setFontSize(10);
            y = 40;

            const sortedTransactions = [...selected].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedTransactions.forEach((t, idx) => {
                doc.text(`${formatDate(t.date)}`, 20, y);
                doc.text(t.merchant.substring(0, 35), 55, y);
                doc.text(`$${t.amount.toFixed(2)}`, 170, y);
                y += 6;

                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
            });

            // Add charts as images
            doc.addPage();
            doc.setFillColor(111, 78, 55);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.text('Charts & Visualizations', 105, 18, { align: 'center' });

            doc.setTextColor(62, 39, 35);
            y = 45;

            // Export charts as images
            try {
                const shopChart = document.getElementById('shopRankingChart');
                if (shopChart) {
                    const shopImg = shopChart.toDataURL('image/png');
                    doc.setFontSize(12);
                    doc.text('Coffee Shops by Spending', 20, y);
                    doc.addImage(shopImg, 'PNG', 15, y + 5, 180, 80);
                    y += 90;
                }

                if (y > 200) {
                    doc.addPage();
                    y = 20;
                }

                const trendChart = document.getElementById('trendChart');
                if (trendChart) {
                    const trendImg = trendChart.toDataURL('image/png');
                    doc.setFontSize(12);
                    doc.text('Weekly Spending Trend', 20, y);
                    doc.addImage(trendImg, 'PNG', 15, y + 5, 180, 80);
                }
            } catch (e) {
                console.log('Could not export charts:', e);
            }

            doc.save('coffee-spending-analysis.pdf');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showError(message) {
            elements.errorContainer.innerHTML = `
                <div class="section">
                    <div class="error-message">âš ï¸ ${message}</div>
                </div>
            `;
        }

        function clearError() {
            elements.errorContainer.innerHTML = '';
        }

        function resetApp() {
            uploadedFiles = [];
            transactions = [];
            elements.fileList.innerHTML = '';
            elements.resultsSection.classList.add('hidden');
            elements.analyzeBtn.disabled = true;
            clearError();
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
        }
    </script>
</body>
</html>